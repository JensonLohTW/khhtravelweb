<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ConfigLoader è‡ªå‹•åŒ–æ¸¬è©¦</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .controls {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .results {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .test-item {
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #ddd;
      background: #f9f9f9;
    }

    .test-item.running {
      border-left-color: #667eea;
      background: #f0f4ff;
    }

    .test-item.pass {
      border-left-color: #22c55e;
      background: #f0fdf4;
    }

    .test-item.fail {
      border-left-color: #ef4444;
      background: #fef2f2;
    }

    .test-title {
      font-weight: 600;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-status {
      font-size: 20px;
    }

    .test-details {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
      line-height: 1.6;
    }

    .test-code {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 8px;
      overflow-x: auto;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .summary-card {
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .summary-card.total {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .summary-card.pass {
      background: #22c55e;
      color: white;
    }

    .summary-card.fail {
      background: #ef4444;
      color: white;
    }

    .summary-card.pending {
      background: #f59e0b;
      color: white;
    }

    .summary-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .summary-label {
      font-size: 12px;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– ConfigLoader è‡ªå‹•åŒ–æ¸¬è©¦</h1>
      <p class="subtitle">Content-Overrides é…ç½®ç³»çµ±å®Œæ•´æ¸¬è©¦å¥—ä»¶</p>
    </div>

    <div class="controls">
      <button class="btn-primary" onclick="runAllTests()">
        <span>â–¶ï¸</span> åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
      </button>
      <button class="btn-secondary" onclick="clearResults()">
        <span>ğŸ”„</span> æ¸…é™¤çµæœ
      </button>
      <button class="btn-secondary" onclick="location.href='index.html'">
        <span>ğŸ </span> è¿”å›ä¸»é 
      </button>
    </div>

    <div class="results">
      <div class="summary" id="summary"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress" style="width: 0%"></div>
      </div>
      <div id="testResults"></div>
    </div>
  </div>

  <script src="vendor/marzipano.js"></script>
  <script src="data.js"></script>
  <script src="modules/environment.js"></script>
  <script src="modules/runtimeConfig.js"></script>
  <script src="modules/configLoader.js"></script>

  <script>
    const tests = [
      {
        name: 'æª¢æŸ¥ç’°å¢ƒé…ç½®',
        description: 'é©—è­‰ RuntimeConfig æ˜¯å¦æ­£ç¢ºè¼‰å…¥',
        test: async () => {
          if (!window.MarzipanoApp || !window.MarzipanoApp.RuntimeConfig) {
            throw new Error('RuntimeConfig æœªå®šç¾©');
          }
          const config = window.MarzipanoApp.RuntimeConfig;
          return {
            environment: config.environment,
            allowSceneRename: config.allowSceneRename
          };
        }
      },
      {
        name: 'æª¢æŸ¥ ConfigLoader å­˜åœ¨',
        description: 'é©—è­‰ ConfigLoader æ¨¡å¡Šæ˜¯å¦æ­£ç¢ºè¼‰å…¥',
        test: async () => {
          if (!window.MarzipanoApp || !window.MarzipanoApp.ConfigLoader) {
            throw new Error('ConfigLoader æœªå®šç¾©');
          }
          const loader = window.MarzipanoApp.ConfigLoader;
          const methods = ['loadContentOverrides', 'normalizeOverrides', 'debugReload', 'debugStatus'];
          const missing = methods.filter(m => typeof loader[m] !== 'function');
          if (missing.length > 0) {
            throw new Error('ç¼ºå°‘æ–¹æ³•: ' + missing.join(', '));
          }
          return { methods: methods.length };
        }
      },
      {
        name: 'è¼‰å…¥é…ç½®æ–‡ä»¶',
        description: 'æ¸¬è©¦å¾æœå‹™å™¨è¼‰å…¥ content-overrides.json',
        test: async () => {
          const config = await window.MarzipanoApp.ConfigLoader.loadContentOverrides();
          if (!config || typeof config !== 'object') {
            throw new Error('é…ç½®æ ¼å¼éŒ¯èª¤');
          }
          return {
            version: config.version,
            scenes: Object.keys(config.scenes).length,
            hotspots: Object.keys(config.hotspots).length
          };
        }
      },
      {
        name: 'é©—è­‰ç·©å­˜ç ´å£æ©Ÿåˆ¶',
        description: 'æª¢æŸ¥é–‹ç™¼æ¨¡å¼æ˜¯å¦æ·»åŠ æ™‚é–“æˆ³åƒæ•¸',
        test: async () => {
          const runtimeConfig = window.MarzipanoApp.RuntimeConfig;
          const isDev = runtimeConfig.environment === 'development';

          // æ•ç²ç¶²çµ¡è«‹æ±‚
          const originalXHR = window.XMLHttpRequest;
          let capturedUrl = null;

          window.XMLHttpRequest = function() {
            const xhr = new originalXHR();
            const originalOpen = xhr.open;
            xhr.open = function(method, url) {
              if (url.includes('content-overrides.json')) {
                capturedUrl = url;
              }
              return originalOpen.apply(this, arguments);
            };
            return xhr;
          };

          await window.MarzipanoApp.ConfigLoader.loadContentOverrides();
          window.XMLHttpRequest = originalXHR;

          const hasTimestamp = capturedUrl && capturedUrl.includes('?v=');

          if (isDev && !hasTimestamp) {
            throw new Error('é–‹ç™¼æ¨¡å¼æ‡‰è©²ä½¿ç”¨æ™‚é–“æˆ³åƒæ•¸');
          }

          return {
            environment: runtimeConfig.environment,
            url: capturedUrl,
            hasTimestamp
          };
        }
      },
      {
        name: 'æ¸¬è©¦é–‹ç™¼å·¥å…·å¯ç”¨æ€§',
        description: 'é©—è­‰é–‹ç™¼æ¨¡å¼çš„èª¿è©¦å·¥å…·',
        test: async () => {
          const runtimeConfig = window.MarzipanoApp.RuntimeConfig;
          const isDev = runtimeConfig.environment === 'development';

          const hasReloadConfig = typeof window.__reloadConfig === 'function';
          const hasConfigStatus = typeof window.__configStatus === 'function';

          if (isDev && (!hasReloadConfig || !hasConfigStatus)) {
            throw new Error('é–‹ç™¼æ¨¡å¼æ‡‰è©²æš´éœ²èª¿è©¦å·¥å…·');
          }

          if (!isDev && (hasReloadConfig || hasConfigStatus)) {
            throw new Error('ç”Ÿç”¢æ¨¡å¼ä¸æ‡‰è©²æš´éœ²èª¿è©¦å·¥å…·');
          }

          return {
            __reloadConfig: hasReloadConfig,
            __configStatus: hasConfigStatus,
            appropriate: true
          };
        }
      },
      {
        name: 'æ¸¬è©¦ debugReload åŠŸèƒ½',
        description: 'é©—è­‰ debugReload() æ˜¯å¦æ­£å¸¸å·¥ä½œ',
        test: async () => {
          const result = await window.MarzipanoApp.ConfigLoader.debugReload();
          if (!result || typeof result !== 'object') {
            throw new Error('debugReload è¿”å›æ ¼å¼éŒ¯èª¤');
          }
          return result;
        }
      },
      {
        name: 'æ¸¬è©¦éŒ¯èª¤è™•ç†ï¼šç„¡æ•ˆ JSON',
        description: 'æ¨¡æ“¬ JSON è§£æéŒ¯èª¤çš„è™•ç†',
        test: async () => {
          // é€™å€‹æ¸¬è©¦éœ€è¦æ¨¡æ“¬ XMLHttpRequest
          const originalXHR = window.XMLHttpRequest;

          window.XMLHttpRequest = function() {
            return {
              open: function() {},
              send: function() {
                setTimeout(() => {
                  this.readyState = 4;
                  this.status = 200;
                  this.responseText = '{ invalid json }';
                  this.onreadystatechange();
                }, 10);
              }
            };
          };

          const config = await window.MarzipanoApp.ConfigLoader.loadContentOverrides();
          window.XMLHttpRequest = originalXHR;

          // æ‡‰è©²è¿”å›ç©ºé…ç½®è€Œä¸æ˜¯æ‹‹å‡ºéŒ¯èª¤
          if (Object.keys(config.scenes).length > 0 || Object.keys(config.hotspots).length > 0) {
            throw new Error('æ‡‰è©²è¿”å›ç©ºé…ç½®');
          }

          return { gracefullyHandled: true };
        }
      },
      {
        name: 'æ¸¬è©¦éŒ¯èª¤è™•ç†ï¼š404 éŒ¯èª¤',
        description: 'æ¨¡æ“¬æ–‡ä»¶ä¸å­˜åœ¨çš„è™•ç†',
        test: async () => {
          const originalXHR = window.XMLHttpRequest;

          window.XMLHttpRequest = function() {
            return {
              open: function() {},
              send: function() {
                setTimeout(() => {
                  this.readyState = 4;
                  this.status = 404;
                  this.responseText = '';
                  this.onreadystatechange();
                }, 10);
              }
            };
          };

          const config = await window.MarzipanoApp.ConfigLoader.loadContentOverrides();
          window.XMLHttpRequest = originalXHR;

          // æ‡‰è©²è¿”å›ç©ºé…ç½®
          if (config.version !== 1 || Object.keys(config.scenes).length > 0) {
            throw new Error('æ‡‰è©²è¿”å›ç©ºé…ç½®');
          }

          return { gracefullyHandled: true };
        }
      },
      {
        name: 'æ¸¬è©¦é…ç½®è¦ç¯„åŒ–',
        description: 'é©—è­‰ normalizeOverrides() å‡½æ•¸',
        test: async () => {
          const testConfig = {
            version: 2,
            scenes: {
              'test-id': {
                name: 'æ¸¬è©¦å ´æ™¯',
                description: 'æ¸¬è©¦æè¿°'
              }
            },
            hotspots: {
              'test-id': {
                infoHotspots: [
                  { index: 0, title: 'æ¸¬è©¦æ¨™é¡Œ', text: 'æ¸¬è©¦å…§å®¹' }
                ]
              }
            }
          };

          const normalized = window.MarzipanoApp.ConfigLoader.normalizeOverrides(testConfig);

          if (normalized.version !== 2) {
            throw new Error('ç‰ˆæœ¬è™Ÿä¸æ­£ç¢º');
          }

          if (!normalized.scenes['test-id'] || normalized.scenes['test-id'].name !== 'æ¸¬è©¦å ´æ™¯') {
            throw new Error('å ´æ™¯æ•¸æ“šä¸æ­£ç¢º');
          }

          return { normalized: true };
        }
      },
      {
        name: 'æ€§èƒ½æ¸¬è©¦ï¼šè¼‰å…¥æ™‚é–“',
        description: 'æ¸¬é‡é…ç½®è¼‰å…¥æ‰€éœ€æ™‚é–“',
        test: async () => {
          const start = performance.now();
          await window.MarzipanoApp.ConfigLoader.loadContentOverrides();
          const end = performance.now();
          const duration = end - start;

          if (duration > 1000) {
            throw new Error(`è¼‰å…¥æ™‚é–“éé•·: ${duration.toFixed(2)}ms`);
          }

          return {
            duration: duration.toFixed(2) + 'ms',
            acceptable: duration < 500
          };
        }
      }
    ];

    let currentTest = 0;
    let passedTests = 0;
    let failedTests = 0;

    function updateSummary() {
      const summary = document.getElementById('summary');
      const progress = document.getElementById('progress');

      const total = tests.length;
      const completed = passedTests + failedTests;
      const pending = total - completed;
      const percentage = (completed / total) * 100;

      progress.style.width = percentage + '%';

      summary.innerHTML = `
        <div class="summary-card total">
          <div class="summary-number">${total}</div>
          <div class="summary-label">ç¸½æ¸¬è©¦æ•¸</div>
        </div>
        <div class="summary-card pass">
          <div class="summary-number">${passedTests}</div>
          <div class="summary-label">é€šé âœ“</div>
        </div>
        <div class="summary-card fail">
          <div class="summary-number">${failedTests}</div>
          <div class="summary-label">å¤±æ•— âœ—</div>
        </div>
        <div class="summary-card pending">
          <div class="summary-number">${pending}</div>
          <div class="summary-label">å¾…æ¸¬è©¦</div>
        </div>
      `;
    }

    async function runTest(test, index) {
      const resultsDiv = document.getElementById('testResults');

      const testDiv = document.createElement('div');
      testDiv.className = 'test-item running';
      testDiv.id = 'test-' + index;
      testDiv.innerHTML = `
        <div class="test-title">
          <span class="test-status spinner">â³</span>
          <span>${test.name}</span>
        </div>
        <div class="test-details">${test.description}</div>
      `;
      resultsDiv.appendChild(testDiv);

      try {
        const result = await test.test();
        testDiv.className = 'test-item pass';
        testDiv.querySelector('.test-status').textContent = 'âœ…';

        if (result && typeof result === 'object') {
          const details = testDiv.querySelector('.test-details');
          details.innerHTML += `<div class="test-code">${JSON.stringify(result, null, 2)}</div>`;
        }

        passedTests++;
        return true;
      } catch (error) {
        testDiv.className = 'test-item fail';
        testDiv.querySelector('.test-status').textContent = 'âŒ';

        const details = testDiv.querySelector('.test-details');
        details.innerHTML += `<div class="test-code" style="background: #7f1d1d; color: #fca5a5;">éŒ¯èª¤: ${error.message}</div>`;

        failedTests++;
        return false;
      } finally {
        updateSummary();
      }
    }

    async function runAllTests() {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = '';
      passedTests = 0;
      failedTests = 0;
      currentTest = 0;

      updateSummary();

      console.log('ğŸ¤– é–‹å§‹åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦...\n');

      for (let i = 0; i < tests.length; i++) {
        currentTest = i;
        console.log(`\nğŸ“ æ¸¬è©¦ ${i + 1}/${tests.length}: ${tests[i].name}`);
        const passed = await runTest(tests[i], i);
        console.log(passed ? '  âœ… é€šé' : '  âŒ å¤±æ•—');

        // ç¨å¾®å»¶é²ä»¥ä¾¿è§€å¯Ÿå‹•ç•«
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      console.log('\n\nğŸ“Š æ¸¬è©¦å®Œæˆï¼');
      console.log(`  ç¸½è¨ˆ: ${tests.length}`);
      console.log(`  é€šé: ${passedTests}`);
      console.log(`  å¤±æ•—: ${failedTests}`);
      console.log(`  æˆåŠŸç‡: ${((passedTests / tests.length) * 100).toFixed(1)}%`);

      if (failedTests === 0) {
        console.log('\nğŸ‰ æ‰€æœ‰æ¸¬è©¦éƒ½é€šéäº†ï¼ç³»çµ±é‹è¡Œæ­£å¸¸ã€‚');
      } else {
        console.log('\nâš ï¸ æœ‰æ¸¬è©¦å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°ä¿¡æ¯ã€‚');
      }
    }

    function clearResults() {
      document.getElementById('testResults').innerHTML = '';
      document.getElementById('summary').innerHTML = '';
      document.getElementById('progress').style.width = '0%';
      passedTests = 0;
      failedTests = 0;
      currentTest = 0;
    }

    // é é¢è¼‰å…¥æ™‚æ›´æ–°æ‘˜è¦
    updateSummary();

    // é¡¯ç¤ºæ­¡è¿ä¿¡æ¯
    console.log('%cğŸ¤– ConfigLoader è‡ªå‹•åŒ–æ¸¬è©¦ç³»çµ±å·²è¼‰å…¥', 'font-size: 20px; font-weight: bold; color: #667eea;');
    console.log('%cé»æ“Šã€ŒåŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ã€æŒ‰éˆ•é–‹å§‹æ¸¬è©¦ï¼Œæˆ–åœ¨æ§åˆ¶å°åŸ·è¡Œ runAllTests()', 'color: #666;');
  </script>
</body>
</html>

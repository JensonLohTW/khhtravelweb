# 🚀 部署指南

## 📌 快速切換：開發模式 ↔ 生產模式

本應用提供了靈活的環境切換機制，可以輕鬆在開發和生產環境之間切換。

---

## 🎯 一鍵切換方法

### 方法一：修改配置文件（★ 推薦）

編輯 `app-files/config.js` 文件：

```javascript
// 開發模式
window.MARZIPANO_APP_ENV = 'development';

// 生產模式（部署前修改為這個）
window.MARZIPANO_APP_ENV = 'production';
```

**優點：**
- ✅ 最簡單直接
- ✅ 一處修改，全局生效
- ✅ 可以版本控制

---

### 方法二：註解配置文件（自動判斷）

編輯 `app-files/config.js`，將設定註解掉：

```javascript
// window.MARZIPANO_APP_ENV = 'development';
```

系統會自動判斷：
- `localhost` / `127.0.0.1` → 開發模式
- 其他域名 → 生產模式

**優點：**
- ✅ 開發和生產環境自動適配
- ✅ 無需手動切換

---

### 方法三：移除配置文件

部署時在 `index.html` 中移除或註解掉 config.js 的載入：

```html
<!-- <script src="config.js"></script> -->
```

**優點：**
- ✅ 最乾淨的生產環境
- ✅ 減少不必要的文件載入

---

## 📋 兩種模式的差異

### 🛠️ 開發模式 (Development)

**啟用時機：**
- `window.MARZIPANO_APP_ENV = 'development'`
- 或在 localhost 上運行（自動判斷）

**可見功能：**
- ✅ 場景列表中的「匯出設定」按鈕
- ✅ 場景名稱編輯功能（雙擊場景名稱）
- ✅ 其他開發輔助工具

**用途：**
- 開發階段使用
- 測試功能
- 內容管理

---

### 🌐 生產模式 (Production)

**啟用時機：**
- `window.MARZIPANO_APP_ENV = 'production'`
- 或在正式域名上運行（自動判斷）

**功能狀態：**
- ❌ 隱藏所有開發工具
- ❌ 禁用場景名稱編輯
- ✅ 只顯示最終用戶功能

**用途：**
- 正式上線環境
- 客戶演示
- 最終產品發布

---

## 🔧 技術細節

### 環境檢測流程

```
1. 檢查 window.MARZIPANO_APP_ENV
   ├─ 有設定 → 使用設定值
   └─ 未設定 → 執行自動判斷
       ├─ hostname = localhost/127.0.0.1 → development
       └─ 其他 → production

2. 根據環境設定控制
   ├─ body.dev-mode class (開發模式時添加)
   └─ runtimeConfig.allowSceneRename (是否允許重命名)

3. CSS 控制顯示
   └─ body.dev-mode .devOnlyButton { display: block; }
```

### 相關文件

| 文件 | 用途 |
|------|------|
| `app-files/config.js` | 環境配置（一鍵切換） |
| `app-files/modules/runtimeConfig.js` | 環境檢測邏輯 |
| `app-files/index.js` | 應用 dev-mode class |
| `app-files/style.css` | 開發功能樣式控制 |

---

## 📦 配置文件管理

### content-overrides.json（內容覆寫配置）

**用途：** 在不修改源代碼的情況下，覆蓋場景名稱、描述和熱點內容。

**文件位置：** `app-files/config/content-overrides.json`

**功能特性：**
- ✅ 開發模式自動繞過瀏覽器緩存（使用時間戳參數）
- ✅ 生產模式使用配置版本號控制
- ✅ 完整的調試日誌和錯誤處理
- ✅ 開發模式提供調試工具（`__reloadConfig()` 和 `__configStatus()`）

**使用場景：**
1. 多語言版本
2. 客戶定制版本
3. 內容快速更新
4. A/B 測試不同文案

**詳細文檔：** 請參閱 [content-overrides使用指南.md](./content-overrides使用指南.md)

**注意事項：**
- 生產環境修改後需強制刷新瀏覽器（Ctrl/Cmd + Shift + R）
- JSON 格式必須正確，否則會回退到默認配置
- 場景ID必須與 `data.js` 中的ID完全匹配

---

## 📦 部署檢查清單

### 部署前檢查

- [ ] 修改 `config.js` 設定為 `'production'`
- [ ] 檢查 `content-overrides.json` 格式正確
- [ ] 測試所有頁面功能正常
- [ ] 確認開發工具已隱藏
- [ ] 檢查控制台無錯誤訊息
- [ ] 測試響應式設計（桌面/移動）
- [ ] 驗證配置覆寫生效

### 部署後檢查

- [ ] 訪問正式網址確認模式正確
- [ ] 驗證場景切換正常
- [ ] 確認場景名稱已應用自定義配置
- [ ] 測試 QR 碼生成功能
- [ ] 檢查媒體庫功能
- [ ] 確認所有熱點內容正確
- [ ] 測試熱點可點擊
- [ ] 強制刷新驗證緩存清除

---

## 🎨 進階：自定義開發功能

如需添加新的開發專用功能，請遵循以下模式：

### HTML

```html
<!-- 使用 devOnlyButton class -->
<button class="btn btn--sm btn--outline devOnlyButton">
  開發專用按鈕
</button>
```

### CSS

```css
/* 默認隱藏 */
.devOnlyButton {
  display: none;
}

/* 開發模式顯示 */
body.dev-mode .devOnlyButton {
  display: block;
}
```

### JavaScript

```javascript
// 檢查是否為開發模式
var runtimeConfig = window.MarzipanoApp.RuntimeConfig;
if (runtimeConfig.environment === 'development') {
  // 開發專用邏輯
  console.log('開發模式啟用');
}
```

---

## ❓ 常見問題

### Q: 部署後仍然看到開發工具？

**A:** 檢查以下幾點：
1. 確認 `config.js` 中設定為 `'production'`
2. 清除瀏覽器緩存（Ctrl+Shift+R / Cmd+Shift+R）
3. 確認上傳了最新版本的文件

### Q: 如何在生產環境臨時啟用開發工具？

**A:** 在瀏覽器控制台執行：
```javascript
window.MARZIPANO_APP_ENV = 'development';
location.reload();
```

### Q: 可以為不同域名設定不同模式嗎？

**A:** 可以，在 `runtimeConfig.js` 中自定義邏輯：
```javascript
if (hostname.includes('test.example.com')) {
  env = 'development';
} else if (hostname.includes('example.com')) {
  env = 'production';
}
```

### Q: 修改 content-overrides.json 後沒有生效？

**A:** 最常見的原因是瀏覽器緩存：
1. **開發模式**：直接刷新即可（F5），系統會自動繞過緩存
2. **生產模式**：需要強制刷新（Ctrl/Cmd + Shift + R）
3. **驗證方法**：
   ```javascript
   // 在控制台執行
   __reloadConfig();  // 開發模式
   ```
4. **檢查載入狀態**：F12 → Network → 搜索 `content-overrides.json`
   - `200 OK` = 成功載入新版本
   - `304 Not Modified` = 使用緩存（需清除）

### Q: 如何驗證配置是否正確載入？

**A:** 查看瀏覽器控制台（F12），應該看到：
```
[ConfigLoader] 📄 載入配置文件: config/content-overrides.json
[ConfigLoader] ✅ 配置載入成功
[ConfigLoader] 📊 配置版本: 1
[ConfigLoader] 🎬 場景覆寫數量: X
[ConfigLoader] 📍 熱點覆寫數量: Y
```

### Q: JSON 格式錯誤如何排查？

**A:**
1. 查看控制台錯誤訊息：`[ConfigLoader] ❌ JSON 解析失敗`
2. 使用在線工具驗證：[JSONLint](https://jsonlint.com/)
3. 常見錯誤：
   - 最後一項後面有多餘逗號
   - 使用單引號而非雙引號
   - 括號不匹配

### Q: 開發模式的調試工具如何使用？

**A:** 在瀏覽器控制台執行：
```javascript
// 重新載入配置
__reloadConfig();

// 查看配置狀態
__configStatus();

// 查看所有場景ID
console.log(window.APP_DATA.scenes.map(s => s.id));
```

---

## 📞 技術支援

如有任何問題，請參考：
- 項目根目錄的 `CLAUDE.md` - 項目整體說明
- 項目根目錄的 `AGENTS.md` - 全局配置模板
- [content-overrides使用指南.md](./content-overrides使用指南.md) - 配置文件詳細說明
- `docs/` 目錄下的其他文檔

---

**最後更新：** 2025-01-05
**版本：** 1.0.0
